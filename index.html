<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trading Journal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    /* Simple fade-in for calendar cells */
    .fade-in {
      animation: fadeIn 0.3s ease-in-out forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    /* Scrollbar for trade list */
    .thin-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .thin-scroll::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 9999px;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold">Trading Journal</h1>
        <span id="monthLabel"
          class="inline-flex items-center rounded-full border border-slate-700 px-3 py-1 text-sm bg-slate-900/70">
          <!-- Filled by JS -->
        </span>
      </div>

      <div class="flex items-center gap-2">
        <button id="prevMonthBtn"
          class="px-3 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">
          ◀ Prev
        </button>
        <button id="todayBtn"
          class="px-3 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">
          This month
        </button>
        <button id="nextMonthBtn"
          class="px-3 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 text-sm">
          Next ▶
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-[2fr,1.1fr] gap-6">
      <!-- LEFT: Calendar + trade form -->
      <div class="space-y-4">
        <!-- Calendar -->
        <div class="rounded-2xl bg-slate-900/80 border border-slate-800 p-4">
          <!-- Day headers -->
          <div class="grid grid-cols-7 text-center text-xs font-semibold text-slate-400 mb-2">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
            <div>Thu</div><div>Fri</div><div>Sat</div>
          </div>

          <!-- Calendar grid -->
          <div id="calendarGrid" class="grid grid-cols-7 gap-2 text-xs sm:text-sm">
            <!-- JS fills cells -->
          </div>
        </div>

        <!-- Add Trade Form -->
        <div class="rounded-2xl bg-slate-900/80 border border-slate-800 p-4">
          <h2 class="text-lg font-semibold mb-3">Log a Trade</h2>
          <form id="tradeForm" class="grid grid-cols-1 sm:grid-cols-4 gap-3">
            <div>
              <label class="block text-xs mb-1 text-slate-300">Date</label>
              <input type="date" id="tradeDate"
                     class="w-full rounded-lg bg-slate-800 border border-slate-700 px-2 py-1.5 text-sm"
                     required />
            </div>
            <div>
              <label class="block text-xs mb-1 text-slate-300">P&L ($)</label>
              <input type="number" id="tradePnL" step="0.01"
                     class="w-full rounded-lg bg-slate-800 border border-slate-700 px-2 py-1.5 text-sm"
                     required />
            </div>
            <div>
              <label class="block text-xs mb-1 text-slate-300">Symbol</label>
              <input type="text" id="tradeSymbol" placeholder="e.g. AUDUSD"
                     class="w-full rounded-lg bg-slate-800 border border-slate-700 px-2 py-1.5 text-sm" />
            </div>
            <div class="sm:col-span-4">
              <label class="block text-xs mb-1 text-slate-300">Notes</label>
              <textarea id="tradeNotes" rows="2"
                        class="w-full rounded-lg bg-slate-800 border border-slate-700 px-2 py-1.5 text-sm"></textarea>
            </div>
            <div class="sm:col-span-4 flex justify-end">
              <button type="submit"
                      class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-sm font-semibold text-slate-950">
                Save Trade
              </button>
            </div>
          </form>
        </div>

        <!-- Recent trades list -->
        <div class="rounded-2xl bg-slate-900/80 border border-slate-800 p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Trades (current month)</h2>
            <button id="clearAllBtn"
                    class="text-xs text-red-400 hover:text-red-300 underline underline-offset-2">
              Clear all data
            </button>
          </div>
          <div id="tradesList" class="max-h-64 overflow-y-auto thin-scroll text-sm space-y-2">
            <!-- JS fills -->
          </div>
        </div>
      </div>

      <!-- RIGHT: Stats side panel -->
      <div class="space-y-4">
        <!-- Monthly stats -->
        <div class="rounded-2xl bg-slate-900/80 border border-slate-800 p-4">
          <div class="flex items-center justify-between mb-4">
            <span class="text-sm font-medium text-slate-300">Monthly stats</span>
            <span id="monthPnLBadge"
                  class="px-3 py-1 rounded-full text-xs font-semibold bg-slate-800">
              <!-- filled by JS -->
            </span>
          </div>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="rounded-xl bg-slate-800/60 px-3 py-2">
              <div class="text-xs text-slate-400">Total P&L</div>
              <div id="totalPnL" class="text-lg font-semibold mt-1">$0</div>
            </div>
            <div class="rounded-xl bg-slate-800/60 px-3 py-2">
              <div class="text-xs text-slate-400">Days traded</div>
              <div id="daysTraded" class="text-lg font-semibold mt-1">0</div>
            </div>
            <div class="rounded-xl bg-slate-800/60 px-3 py-2">
              <div class="text-xs text-slate-400">Best day</div>
              <div id="bestDay" class="text-lg font-semibold mt-1">$0</div>
            </div>
            <div class="rounded-xl bg-slate-800/60 px-3 py-2">
              <div class="text-xs text-slate-400">Worst day</div>
              <div id="worstDay" class="text-lg font-semibold mt-1">$0</div>
            </div>
          </div>
        </div>

        <!-- Weekly stats -->
        <div class="rounded-2xl bg-slate-900/80 border border-slate-800 p-4">
          <h2 class="text-sm font-medium text-slate-300 mb-3">Weeks</h2>
          <div id="weeksList" class="space-y-2 text-sm">
            <!-- JS fills weekly P&L -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP SCRIPT -->
  <script>
    // ======= Storage helpers =======
    const STORAGE_KEY = "tradingJournalTrades_v1";

    function loadTrades() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    function saveTrades(trades) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(trades));
    }

    let trades = loadTrades();

    // Each trade: { id, date: "YYYY-MM-DD", pnl: number, symbol, notes }

    // ======= Date helpers =======
    let current = new Date();
    let currentMonth = current.getMonth(); // 0-11
    let currentYear = current.getFullYear();

    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function getMonthLabel(year, monthIndex) {
      const formatter = new Intl.DateTimeFormat("en-US", {
        month: "long",
        year: "numeric",
      });
      return formatter.format(new Date(year, monthIndex, 1));
    }

    function getDaysInMonth(year, monthIndex) {
      return new Date(year, monthIndex + 1, 0).getDate();
    }

    // ======= Aggregation =======
    function getDailyTotalsForMonth(year, monthIndex) {
      const result = {};
      const monthStr = String(monthIndex + 1).padStart(2, "0");
      const yearStr = String(year);

      for (const t of trades) {
        if (!t.date) continue;
        // t.date expected "YYYY-MM-DD"
        const [y, m, d] = t.date.split("-");
        if (y === yearStr && m === monthStr) {
          const key = `${y}-${m}-${d}`;
          const pnl = Number(t.pnl) || 0;
          if (!result[key]) result[key] = 0;
          result[key] += pnl;
        }
      }
      return result;
    }

    function getWeekIndex(dayOfMonth, firstDayIndex) {
      // firstDayIndex is 0-6, where 0 = Sunday
      // Example: if month starts on Wed (3), days 1-4 are in week 1, etc.
      const offset = firstDayIndex; // days shifted before first of month
      const zeroBased = dayOfMonth - 1 + offset;
      const weekIndex = Math.floor(zeroBased / 7); // 0-based
      return weekIndex; // 0..5
    }

    // ======= Rendering calendar =======
    const calendarGrid = document.getElementById("calendarGrid");
    const monthLabelEl = document.getElementById("monthLabel");

    function renderCalendar() {
      const year = currentYear;
      const month = currentMonth;

      monthLabelEl.textContent = getMonthLabel(year, month);

      calendarGrid.innerHTML = "";

      const firstDayIndex = new Date(year, month, 1).getDay(); // 0=Sun
      const daysInMonth = getDaysInMonth(year, month);
      const dailyTotals = getDailyTotalsForMonth(year, month);

      // For weekly stats
      const weeklyTotals = [0, 0, 0, 0, 0, 0];

      // Fill cells (we’ll make a fixed 42-cell grid)
      const totalCells = 42;
      let dayNum = 1;

      for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement("div");
        cell.className =
          "relative rounded-xl bg-slate-900 border border-slate-800 min-h-[80px] p-2 flex flex-col gap-1 fade-in";

        if (i < firstDayIndex || dayNum > daysInMonth) {
          cell.classList.add("opacity-30");
          calendarGrid.appendChild(cell);
          continue;
        }

        const dateObj = new Date(year, month, dayNum);
        const key = formatDateKey(dateObj);
        const dayTotal = dailyTotals[key] || 0;

        // Update weekly totals
        const wIndex = getWeekIndex(dayNum, firstDayIndex);
        weeklyTotals[wIndex] += dayTotal;

        const dayHeader = document.createElement("div");
        dayHeader.className = "flex items-center justify-between text-xs";

        const dayNumberEl = document.createElement("span");
        dayNumberEl.textContent = dayNum;
        dayNumberEl.className = "font-semibold text-slate-200";

        dayHeader.appendChild(dayNumberEl);

        const tradeCount = trades.filter((t) => t.date === key).length;
        if (tradeCount > 0) {
          const badge = document.createElement("span");
          badge.textContent = `${tradeCount} trade${tradeCount > 1 ? "s" : ""}`;
          badge.className =
            "text-[10px] px-2 py-0.5 rounded-full bg-slate-800 text-slate-300";
          dayHeader.appendChild(badge);
        }

        cell.appendChild(dayHeader);

        // P&L section
        const pnlEl = document.createElement("div");
        pnlEl.className = "mt-1 text-sm font-semibold";

        if (dayTotal > 0) {
          pnlEl.textContent = `+$${dayTotal.toFixed(2)}`;
          pnlEl.classList.add("text-emerald-400");
        } else if (dayTotal < 0) {
          pnlEl.textContent = `-$${Math.abs(dayTotal).toFixed(2)}`;
          pnlEl.classList.add("text-red-400");
        } else {
          pnlEl.textContent = "$0.00";
          pnlEl.classList.add("text-slate-500");
        }

        cell.appendChild(pnlEl);

        calendarGrid.appendChild(cell);
        dayNum++;
      }

      renderStats(dailyTotals, weeklyTotals);
      renderTradesList();
    }

    // ======= Stats rendering =======
    const totalPnLEl = document.getElementById("totalPnL");
    const daysTradedEl = document.getElementById("daysTraded");
    const bestDayEl = document.getElementById("bestDay");
    const worstDayEl = document.getElementById("worstDay");
    const monthPnLBadge = document.getElementById("monthPnLBadge");
    const weeksListEl = document.getElementById("weeksList");

    function formatPnL(value) {
      const abs = Math.abs(value).toFixed(2);
      if (value > 0) return `+$${abs}`;
      if (value < 0) return `-$${abs}`;
      return "$0.00";
    }

    function renderStats(dailyTotals, weeklyTotals) {
      const totals = Object.values(dailyTotals);
      const total = totals.reduce((acc, v) => acc + v, 0);

      totalPnLEl.textContent = formatPnL(total);
      daysTradedEl.textContent = totals.length;

      const best = totals.length ? Math.max(...totals) : 0;
      const worst = totals.length ? Math.min(...totals) : 0;

      bestDayEl.textContent = formatPnL(best);
      worstDayEl.textContent = formatPnL(worst);

      // Badge color
      monthPnLBadge.textContent = `PNL: ${formatPnL(total)}`;
      monthPnLBadge.classList.remove(
        "bg-emerald-500/20",
        "text-emerald-300",
        "bg-red-500/20",
        "text-red-300",
        "bg-slate-700",
        "text-slate-200"
      );
      if (total > 0) {
        monthPnLBadge.classList.add("bg-emerald-500/20", "text-emerald-300");
      } else if (total < 0) {
        monthPnLBadge.classList.add("bg-red-500/20", "text-red-300");
      } else {
        monthPnLBadge.classList.add("bg-slate-700", "text-slate-200");
      }

      // Weekly list
      weeksListEl.innerHTML = "";
      weeklyTotals.forEach((wTotal, idx) => {
        // Hide empty weeks at the end
        const isAllZeroAfter = weeklyTotals
          .slice(idx)
          .every((v) => Math.abs(v) < 0.0001);
        if (isAllZeroAfter && Math.abs(wTotal) < 0.0001 && idx > 3) return;

        const row = document.createElement("div");
        row.className =
          "flex items-center justify-between rounded-xl bg-slate-800/60 px-3 py-2";

        const left = document.createElement("div");
        left.innerHTML = `<div class="text-xs text-slate-400">Week ${
          idx + 1
        }</div>
                          <div class="text-[11px] text-slate-500">${
                            wTotal === 0 ? "No trades" : "PnL"
                          }</div>`;

        const right = document.createElement("div");
        right.className = "text-sm font-semibold";
        right.textContent = formatPnL(wTotal);
        if (wTotal > 0) right.classList.add("text-emerald-400");
        else if (wTotal < 0) right.classList.add("text-red-400");
        else right.classList.add("text-slate-400");

        row.appendChild(left);
        row.appendChild(right);
        weeksListEl.appendChild(row);
      });
    }

    // ======= Trades list =======
    const tradesListEl = document.getElementById("tradesList");

    function renderTradesList() {
      const yearStr = String(currentYear);
      const monthStr = String(currentMonth + 1).padStart(2, "0");

      const currentMonthTrades = trades
        .filter((t) => t.date.startsWith(`${yearStr}-${monthStr}-`))
        .sort((a, b) => (a.date < b.date ? -1 : 1));

      tradesListEl.innerHTML = "";

      if (currentMonthTrades.length === 0) {
        tradesListEl.innerHTML =
          '<p class="text-xs text-slate-500">No trades logged for this month yet.</p>';
        return;
      }

      for (const t of currentMonthTrades) {
        const row = document.createElement("div");
        row.className =
          "flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1 border-b border-slate-800 pb-1";

        const left = document.createElement("div");
        left.innerHTML = `<span class="text-xs text-slate-400">${t.date}</span>
                          <span class="ml-2 text-xs uppercase text-slate-500">${t.symbol || ""}</span>
                          ${
                            t.notes
                              ? `<div class="text-[11px] text-slate-500 mt-0.5">${t.notes}</div>`
                              : ""
                          }`;

        const right = document.createElement("div");
        right.className = "text-sm font-semibold";
        const pnlVal = Number(t.pnl) || 0;
        right.textContent = formatPnL(pnlVal);
        if (pnlVal > 0) right.classList.add("text-emerald-400");
        else if (pnlVal < 0) right.classList.add("text-red-400");
        else right.classList.add("text-slate-400");

        row.appendChild(left);
        row.appendChild(right);
        tradesListEl.appendChild(row);
      }
    }

    // ======= Form handling =======
    const tradeForm = document.getElementById("tradeForm");
    const tradeDate = document.getElementById("tradeDate");
    const tradePnL = document.getElementById("tradePnL");
    const tradeSymbol = document.getElementById("tradeSymbol");
    const tradeNotes = document.getElementById("tradeNotes");

    // Default date = today
    tradeDate.value = formatDateKey(new Date());

    tradeForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const date = tradeDate.value;
      const pnl = Number(tradePnL.value);
      if (!date || isNaN(pnl)) return;

      const trade = {
        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
        date,
        pnl,
        symbol: tradeSymbol.value.trim(),
        notes: tradeNotes.value.trim(),
      };

      trades.push(trade);
      saveTrades(trades);

      // Reset some fields
      tradePnL.value = "";
      tradeSymbol.value = "";
      tradeNotes.value = "";

      // Jump calendar to month of that trade
      const d = new Date(date);
      currentYear = d.getFullYear();
      currentMonth = d.getMonth();

      renderCalendar();
    });

    // ======= Month navigation =======
    document.getElementById("prevMonthBtn").addEventListener("click", () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar();
    });

    document.getElementById("nextMonthBtn").addEventListener("click", () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    });

    document.getElementById("todayBtn").addEventListener("click", () => {
      const now = new Date();
      currentMonth = now.getMonth();
      currentYear = now.getFullYear();
      renderCalendar();
    });

    // Clear all data
    document.getElementById("clearAllBtn").addEventListener("click", () => {
      if (!confirm("Delete ALL saved trades? This cannot be undone.")) return;
      trades = [];
      saveTrades(trades);
      renderCalendar();
    });

    // ======= Initial render =======
    renderCalendar();
  </script>
</body>
</html>
